<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shift Time Bakery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;700&family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root {
      --frame-bg: #fdf7ec;
      --frame-border: #c69b63;
      --card-bg: #fffbf5;
      --card-border: #e7c5a1;
      --accent: #e58b55;
      --accent-dark: #b46339;
      --text-main: #3d2819;
      --text-soft: #806152;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "M PLUS Rounded 1c", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: #000 url("backgrounds/bakery.png") center center / cover no-repeat fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      user-select: none;
    }

    input,
    textarea {
      user-select: text;
    }

    body.no-animations *,
    body.no-animations *::before,
    body.no-animations *::after {
      transition: none !important;
      animation: none !important;
    }

    /* Fixed window frame */

    .app-frame {
      width: 960px;
      max-width: 100%;
      height: 640px;
      max-height: 640px;
      background: var(--frame-bg);
      border: 3px solid var(--frame-border);
      box-shadow:
        0 0 0 3px #f9e3b8,
        0 12px 32px rgba(0, 0, 0, 0.45);
      padding: 6px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (max-width: 720px) {
      .app-frame {
        height: 100vh;
        max-height: 100vh;
      }
    }

    .app-frame-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 4px 4px;
      border-bottom: 2px solid #e4c38b;
      font-size: 0.7rem;
    }

    .topbar-title {
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.06em;
    }

    .topbar-dots {
      display: flex;
      gap: 4px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 0;
      border: 2px solid #8b5a2b;
      background: #ffe7b3;
    }

    .dot:nth-child(2) {
      background: #ffbe8e;
    }
    .dot:nth-child(3) {
      background: #f48d62;
    }

    .app {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.2fr);
      gap: 6px;
      overflow: hidden;
      margin-top: 4px;
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 0;
      border: 2px solid var(--card-border);
      padding: 8px 8px 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: hidden;
    }

    /* Left: main / tabs */

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-subtitle {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .status-pill {
      font-size: 0.68rem;
      padding: 3px 6px;
      border-radius: 0;
      border: 1px solid #f2c89c;
      background: #fff2de;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .status-cluster {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .weather-pill {
      min-width: 32px;
      min-height: 28px;
      border: 1px solid #f2c89c;
      background: #fff2de;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      padding: 0 6px;
    }

    .status-pill span {
      font-size: 0.9rem;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      border-bottom: 1px solid #f0d6b8;
      padding-bottom: 4px;
    }

    .tab-btn {
      border: 1px solid transparent;
      background: transparent;
      font-size: 0.72rem;
      padding: 4px 8px;
      border-radius: 0;
      cursor: pointer;
      color: var(--text-soft);
    }

    .tab-btn.active {
      color: var(--accent-dark);
      background: #ffe9d1;
      border-color: #f2c89c;
    }

    .tab-scroll {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .tab-content {
      display: none;
      font-size: 0.8rem;
    }

    .tab-content.active {
      display: block;
    }

    /* Inputs area */

    .inputs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .field {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    label {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    input[type="time"],
    input[type="text"] {
      background: #fff4e6;
      border: 1px solid #e1c2a7;
      border-radius: 0;
      padding: 4px 6px;
      font: inherit;
      color: var(--text-main);
    }

    input[type="time"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px #ffd9b8;
    }

    .btn-main {
      margin-top: 2px;
      padding: 6px 8px;
      border-radius: 0;
      border: 2px solid var(--accent-dark);
      background: repeating-linear-gradient(
        -45deg,
        #ffcf9f,
        #ffcf9f 3px,
        #ffc390 3px,
        #ffc390 6px
      );
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent-dark);
      cursor: pointer;
      width: 100%;
    }

    .btn-main:active {
      transform: translateY(1px);
      box-shadow: inset 0 0 0 2px rgba(165, 83, 44, 0.3);
    }

    .error-text {
      font-size: 0.7rem;
      color: #b30000;
      margin-top: 4px;
      min-height: 14px;
    }

    /* Cards */

    .card {
      background: #fffaf2;
      border-radius: 0;
      border: 1px solid #f1d2ac;
      padding: 6px 6px 4px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.75rem;
      color: #b07a5f;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .countdown-main {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .countdown-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: #ffe8cf;
      border-radius: 0;
      border: 1px solid #e6c09e;
      overflow: hidden;
      position: relative;
      margin-bottom: 4px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #f39f5a, #f7c46a);
      transition: width 0.3s ease-out;
    }

    .progress-meta {
      font-size: 0.74rem;
      color: var(--text-soft);
    }

    .anchor-text {
      font-size: 0.76rem;
      margin-top: 2px;
      color: var(--text-soft);
    }

    .phase-text {
      font-size: 0.76rem;
      margin-top: 2px;
      color: var(--text-soft);
      font-style: italic;
    }

    /* Units */

    .units-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .sort-btns {
      display: inline-flex;
      gap: 3px;
    }

    .sort-btn {
      font-size: 0.7rem;
      border-radius: 0;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      padding: 2px 6px;
      cursor: pointer;
      color: var(--text-soft);
    }

    .sort-btn.active {
      background: #ffe3c0;
      color: var(--accent-dark);
    }

    .units-list {
      display: grid;
      gap: 3px;
      font-size: 0.78rem;
    }

    .unit-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .unit-label {
      color: var(--text-soft);
    }

    .unit-value {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      color: var(--accent-dark);
    }

    .reward-line {
      font-size: 0.78rem;
      margin-top: 4px;
      color: var(--text-soft);
    }

    .reward-line strong {
      color: var(--text-main);
    }

    /* Comparisons */

    .comparison-list {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: grid;
      gap: 2px;
    }

    /* Right panel */

    .side-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #b07a5f;
      margin-bottom: 4px;
    }

    .quote-text {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .small-btn {
      font-size: 0.72rem;
      padding: 3px 6px;
      border-radius: 0;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      cursor: pointer;
      color: var(--text-soft);
    }

    .small-btn:active {
      transform: translateY(1px);
    }

    .inline-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .tip-text {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .weather-summary {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .weather-days {
      display: grid;
      gap: 4px;
    }

    .weather-day {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #f1d2ac;
      padding: 4px 6px;
      background: #fffaf2;
      font-size: 0.78rem;
    }

    .weather-day span:first-child {
      font-weight: 600;
    }

    .slack-form {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .slack-form input[type="text"] {
      flex: 1 1 120px;
    }

    .slacking-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .slacking-corner {
      display: inline-flex;
      gap: 4px;
    }

    .tiny-icon-btn {
      border: 1px solid #d9b48b;
      background: #fff4e5;
      font-size: 0.75rem;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .tiny-icon-btn:active {
      transform: translateY(1px);
    }

    .slack-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .slack-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #f1d2ac;
      padding: 4px 6px;
      background: #fffaf2;
      font-size: 0.78rem;
      gap: 4px;
    }

    .slack-item-label {
      font-weight: 600;
    }

    .slack-item-time {
      color: var(--text-soft);
      font-size: 0.74rem;
    }

    .slack-item-actions {
      display: inline-flex;
      gap: 3px;
    }

    .slack-empty {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .slack-error {
      font-size: 0.72rem;
      color: #b30000;
      min-height: 14px;
    }

    .mood-row {
      display: flex;
      gap: 6px;
      margin: 4px 0;
    }

    .mood-btn {
      flex: 1;
      font-size: 0.78rem;
      padding: 4px 6px;
      border-radius: 0;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .mood-btn.active {
      background: #ffe3c0;
      border-color: var(--accent);
    }

    .mood-msg {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .water-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin: 4px 0;
    }

    .water-count {
      font-size: 0.8rem;
    }

    .water-bar {
      width: 100%;
      height: 8px;
      background: #ffe8cf;
      border-radius: 0;
      border: 1px solid #e6c09e;
      overflow: hidden;
      margin-top: 3px;
    }

    .water-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #60a5fa, #93c5fd);
      transition: width 0.3s ease-out;
    }

    .water-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .cook-btn {
      width: 100%;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 0;
      border: 1px dashed #f2b199;
      background: #fff2ec;
      font-size: 0.78rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--accent-dark);
    }

    .cook-btn:active {
      transform: translateY(1px);
    }

    /* Settings */

    .settings-group {
      margin-bottom: 8px;
    }

    .settings-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #b07a5f;
      margin-bottom: 2px;
    }

    .settings-option-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 2px;
      font-size: 0.78rem;
    }

    .settings-hint {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    /* native radios / checkboxes tweaks */

    input[type="radio"],
    input[type="checkbox"] {
      accent-color: var(--accent-dark);
      border-radius: 0;
      margin-right: 4px;
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .modal {
      background: #fffaf2;
      border-radius: 0;
      border: 2px solid #f2b199;
      padding: 10px 12px;
      max-width: 320px;
      width: calc(100% - 32px);
      font-size: 0.82rem;
    }

    .modal-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .modal-btn {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 0;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      cursor: pointer;
    }

    .modal-btn.primary {
      border-color: var(--accent-dark);
      background: #ffe3c0;
      color: var(--accent-dark);
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <div class="app-frame-topbar">
      <div class="topbar-title">SHIFT TIME BAKERY.exe</div>
      <div class="topbar-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>

    <div class="app">
      <!-- Left: main / tabs -->
      <div class="panel">
        <div class="header">
          <div class="title-block">
            <div class="app-subtitle">lofi shift survival, not productivity</div>
          </div>
          <div class="status-cluster">
            <div class="status-pill" id="status-pill">
              <span>üôÇ</span><span id="status-text">Status: present</span>
            </div>
            <div class="weather-pill" id="weather-emoji" title="Peeking out the bakery window">--</div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab-btn active" data-tab="now">Now</button>
          <button class="tab-btn" data-tab="survival">Survival Kit</button>
          <button class="tab-btn" data-tab="settings">Settings</button>
        </div>

        <div class="tab-scroll">
          <!-- TAB: NOW -->
          <div class="tab-content active" id="tab-now">
            <div class="inputs-row">
              <div class="field">
                <label for="start-time">Shift start</label>
                <input type="time" id="start-time" value="09:00" />
              </div>
              <div class="field">
                <label for="end-time">Shift end</label>
                <input type="time" id="end-time" value="17:00" />
              </div>
              <div class="field">
                <label for="reward-text">After work I‚Äôll‚Ä¶ (optional)</label>
                <input type="text" id="reward-text" placeholder="play games / draw / do nothing" />
              </div>
            </div>
            <button class="btn-main" id="recalc-btn">Recalculate my suffering</button>
            <div class="error-text" id="error-text"></div>

            <div class="card">
              <div class="card-title">Countdown</div>
              <div class="countdown-main" id="countdown-main">--:--:--</div>
              <div class="countdown-sub" id="countdown-sub">Set your shift times to begin.</div>

              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="progress-meta" id="progress-meta">Shift: -- | Done: -- | Left: --</div>
              <div class="phase-text" id="phase-text"></div>
              <div class="anchor-text" id="anchor-text"></div>
              <div class="anchor-text" id="now-water-strip"></div>
            </div>

            <div class="card">
              <div class="units-header">
                <div class="card-title">Remaining time in tiny units</div>
                <div class="sort-btns">
                  <button class="sort-btn active" id="sort-short">Shortest first</button>
                  <button class="sort-btn" id="sort-long">Biggest first</button>
                </div>
              </div>
              <div class="units-list" id="units-list"></div>
              <div class="reward-line" id="reward-line"></div>
            </div>

            <div class="card">
              <div class="card-title">Cozy comparisons</div>
              <div class="comparison-list" id="comparison-list"></div>
            </div>

            <div class="card">
              <div class="card-title">Water this shift</div>
              <div class="water-row">
                <div class="water-count">
                  <span id="now-water-count">0</span>/<span id="now-water-goal">0</span> glasses
                </div>
                <button class="small-btn" id="now-water-add-btn">I drank water üíß</button>
              </div>
              <div class="water-bar">
                <div class="water-fill" id="now-water-fill"></div>
              </div>
            </div>
          </div>

          <!-- TAB: SURVIVAL -->
          <div class="tab-content" id="tab-survival">
            <div class="card">
              <div class="side-section-title">Support quote</div>
              <div class="quote-text" id="quote-text"></div>
              <button class="small-btn" id="quote-next-btn">New quote</button>
              <div class="inline-meta" id="quote-meta"></div>
            </div>

            <div class="card">
              <div class="side-section-title">Legal slacking & survival ideas</div>
              <div class="tip-text" id="tip-text"></div>
              <button class="small-btn" id="tip-next-btn">Show another</button>
            </div>

            <div class="card">
              <div class="side-section-title">How cooked are you?</div>
              <div class="mood-row">
                <button class="mood-btn active" data-mood="ok"><span>üòå</span><span>okay</span></button>
                <button class="mood-btn" data-mood="tired"><span>üòë</span><span>tired</span></button>
                <button class="mood-btn" data-mood="cooked"><span>üòµ</span><span>cooked</span></button>
              </div>
              <div class="mood-msg" id="mood-msg"></div>
            </div>

            <div class="card">
              <div class="side-section-title">Water check</div>
              <div class="water-row">
                <div class="water-count">
                  <span id="water-count">0</span>/<span id="water-goal">0</span> glasses this shift
                </div>
                <button class="small-btn" id="water-add-btn">I drank water üíß</button>
              </div>
              <div class="water-bar">
                <div class="water-fill" id="water-fill"></div>
              </div>
              <div class="water-meta" id="water-meta"></div>
            </div>

            <button class="cook-btn" id="cook-btn">
              <span>üç≥</span>
              <span>I‚Äôm mentally clocked out</span>
            </button>
          </div>

          <!-- TAB: SETTINGS -->
          <div class="tab-content" id="tab-settings">
            <div class="settings-group">
              <div class="settings-title">Support tone</div>
              <div class="settings-option-row">
                <label><input type="radio" name="tone" value="soft" checked> Soft & gentle</label>
              </div>
              <div class="settings-option-row">
                <label><input type="radio" name="tone" value="dark"> Dark humor</label>
              </div>
              <div class="settings-option-row">
                <label><input type="radio" name="tone" value="blunt"> Blunt but kind</label>
              </div>
            </div>

            <div class="settings-group">
              <div class="settings-title">Visual comfort</div>
              <label><input type="checkbox" id="toggle-animations"> Disable animations / smooth transitions</label>
              <div class="settings-hint">For motion sensitivity or if you just like it snappy.</div>
            </div>

            <div class="settings-group">
              <div class="settings-title">Future stuff</div>
              <div class="settings-hint">
                Themes (rainy city, night konbini) and ‚Äúoffice mode‚Äù will live here later.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right panel -->
      <div class="panel">
        <div class="side-section-title">Today in the bakery</div>
        <div style="font-size:0.8rem; color:var(--text-soft); margin-bottom:8px;">
          This little dashboard is here to remind you there is more to life than this shift.
          You‚Äôre not your productivity. You‚Äôre just a tired person in a cozy fake .exe window.
        </div>

        <div class="card">
          <div class="side-section-title">Quick summary</div>
          <div id="summary-text" style="font-size:0.8rem;"></div>
        </div>

        <div class="card">
          <div class="side-section-title">Tiny reminder</div>
          <div style="font-size:0.8rem;" id="reminder-text"></div>
        </div>

        <div class="card" id="weather-card">
          <div class="side-section-title">Weather spells</div>
          <div class="weather-summary" id="weather-summary">Peeking outside‚Ä¶</div>
          <div class="weather-days">
            <div class="weather-day" id="weather-today"><span>Today</span><span>--</span></div>
            <div class="weather-day" id="weather-tomorrow"><span>Tomorrow</span><span>--</span></div>
          </div>
        </div>

        <div class="card">
          <div class="side-section-title slacking-head">
            Slacking schedule
            <div class="slacking-corner">
              <button type="button" class="tiny-icon-btn" id="slack-add-btn" title="Add this break">+</button>
              <button type="button" class="tiny-icon-btn" id="slack-remove-btn" title="Remove last break">‚àí</button>
            </div>
          </div>
          <div class="slack-form">
            <input type="text" id="slack-label" placeholder="fika break" />
            <input type="time" id="slack-time" />
          </div>
          <div class="slack-error" id="slack-error"></div>
          <div class="slack-list" id="slack-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cooked modal -->
  <div class="modal-backdrop" id="cook-modal">
    <div class="modal">
      <div class="modal-title">Cooked mode: ON</div>
      <div id="cook-modal-body">
        Your brain has officially clocked out. From here on out, bare-minimum mode is valid:
        <ul>
          <li>Do only what‚Äôs genuinely urgent.</li>
          <li>Say ‚ÄúI‚Äôll get back to this later‚Äù more often.</li>
          <li>Let the clock do the heavy lifting. You‚Äôre just waiting it out.</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="cook-dismiss">Ok, I‚Äôll coast</button>
      </div>
    </div>
  </div>

  <script>
    // --------- STATE & CONSTANTS ---------

    const STORAGE_KEY = "shiftTimeBakeryState_v3";

    const DEFAULT_STATE = {
      settings: {
        tone: "soft",
        animations: true,
        waterGoal: 4
      },
      shift: {
        start: "09:00",
        end: "17:00",
        reward: ""
      },
      water: {
        date: null,
        count: 0,
        lastSipTs: null
      },
      slacking: {
        breaks: []
      },
      ui: {
        sortMode: "short",
        mood: "ok",
        cooked: false
      }
    };

    let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

    const QUOTES = {
      soft: [
        "Being autistic at work is hard mode. You‚Äôre doing more than enough just by existing here.",
        "You are not your productivity. Surviving this shift is already a lot.",
        "You‚Äôre not behind in life. You‚Äôre just tired and doing your best in a loud world.",
        "It‚Äôs okay if your brain wandered today. That‚Äôs not failure, that‚Äôs coping."
      ],
      dark: [
        "You didn‚Äôt choose the grindset. The grindset chose you. You‚Äôre allowed to opt out mentally.",
        "Late stage capitalism speedrun: survive today, complain about it later online.",
        "Your brain is a premium limited-edition item. This job is on a free trial.",
        "They‚Äôre paying for your time, not your soul. Keep the soul."
      ],
      blunt: [
        "You are not the problem. The environment is not built for your nervous system.",
        "You‚Äôre not lazy. You‚Äôre overloaded. There‚Äôs a difference.",
        "Masking for 8 hours is a full-time job on top of your full-time job.",
        "You are allowed to want more than this. That doesn‚Äôt make you ungrateful."
      ]
    };

    const TIPS = [
      "Micro-break: stare at something at least 5 meters away for 20 seconds. Eyes and brain both reset.",
      "Write down one thing that‚Äôs bothering you about work. You don‚Äôt have to fix it, just park it.",
      "Change your posture for 30 seconds: roll your shoulders, unclench your jaw, wiggle your toes.",
      "If a task feels impossible, break it into the smallest step you can think of and only commit to that.",
      "Lower your screen brightness a little if you can. Your nervous system will say thank you.",
      "Make a tiny plan for after work: one small nice thing. Your brain likes having something to orbit.",
      "If masking is heavy, reduce it by just 5% for the next 10 minutes. You don‚Äôt have to be perfect."
    ];

    const MOOD_MESSAGES = {
      ok: "Nice. Use some of that energy to be kind to Future-You, not just the job.",
      tired: "You‚Äôre allowed to coast. 70% effort is still effort.",
      cooked: "Cooked mode: from here on, survival > performance."
    };

    const REMINDERS = [
      "You are not a machine. You are a person doing their best in weird circumstances.",
      "There is a version of your life after this job. You‚Äôre allowed to walk toward it slowly.",
      "Doing less than your theoretical maximum is still valid. You‚Äôre not a productivity app.",
      "Your worth is not measured in emails answered or tasks completed."
    ];

    const UNITS = [
      { label: "Lo-fi tracks (3 min)", minutes: 3 },
      { label: "Tea distractions (5 min)", minutes: 5 },
      { label: "Window-staring loops (90 sec)", minutes: 1.5 },
      { label: "Tiny brain breaks (30 sec)", minutes: 0.5 },
      { label: "Imaginary bakery doodles (7 min)", minutes: 7 },
      { label: "Scrolling sessions (2 min)", minutes: 2 }
    ];

    const DEFAULT_LOCATION = { lat: 59.3293, lon: 18.0686 };
    const WEATHER_CODE_EMOJI = {
      0: "‚òÄÔ∏è",
      1: "üå§Ô∏è",
      2: "‚õÖ",
      3: "‚òÅÔ∏è",
      45: "üå´Ô∏è",
      48: "üå´Ô∏è",
      51: "üå¶Ô∏è",
      53: "üå¶Ô∏è",
      55: "üåßÔ∏è",
      56: "üåßÔ∏è",
      57: "üåßÔ∏è",
      61: "üåßÔ∏è",
      63: "üåßÔ∏è",
      65: "üåßÔ∏è",
      66: "üåßÔ∏è",
      67: "üåßÔ∏è",
      71: "üå®Ô∏è",
      73: "üå®Ô∏è",
      75: "‚ùÑÔ∏è",
      77: "üå®Ô∏è",
      80: "üå¶Ô∏è",
      81: "üåßÔ∏è",
      82: "‚õàÔ∏è",
      85: "‚ùÑÔ∏è",
      86: "‚ùÑÔ∏è",
      95: "‚õàÔ∏è",
      96: "‚õàÔ∏è",
      99: "‚õàÔ∏è"
    };

    const WEATHER_CODE_TEXT = {
      0: "clear skies",
      1: "mostly clear",
      2: "partly cloudy",
      3: "cloud blanket",
      45: "foggy vibes",
      48: "foggy vibes",
      51: "light drizzle",
      53: "gentle drizzle",
      55: "steady rain",
      56: "icy drizzle",
      57: "icy drizzle",
      61: "light rain",
      63: "rain showers",
      65: "heavy rain",
      66: "freezing rain",
      67: "freezing rain",
      71: "light snow",
      73: "snow",
      75: "heavy snow",
      77: "snow grains",
      80: "showers",
      81: "showers",
      82: "stormy showers",
      85: "snow bursts",
      86: "snow bursts",
      95: "thunderstorm",
      96: "thunderstorm",
      99: "storm drama"
    };

    let quoteIndex = 0;
    let tipIndex = 0;
    let reminderIndex = 0;
    let summaryLast = "";
    let weatherState = {
      emoji: "--",
      summary: "Peeking outside‚Ä¶",
      today: null,
      tomorrow: null
    };

    // --------- UTIL ---------

    function parseTimeToMinutes(timeStr) {
      if (!timeStr) return null;
      const [h, m] = timeStr.split(":").map(Number);
      if (Number.isNaN(h) || Number.isNaN(m)) return null;
      return h * 60 + m;
    }

    function getCurrentMinutes() {
      const now = new Date();
      return now.getHours() * 60 + now.getMinutes();
    }

    function clamp(num, min, max) {
      return Math.min(Math.max(num, min), max);
    }

    function formatHM(mins) {
      if (mins == null) return "--";
      const sign = mins < 0 ? "-" : "";
      const abs = Math.abs(mins);
      const h = Math.floor(abs / 60);
      const m = abs % 60;
      if (h === 0) return sign + m + " min";
      return sign + h + "h " + m + "m";
    }

    function formatHMS(seconds) {
      if (seconds < 0) seconds = 0;
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      const hh = String(h).padStart(2, "0");
      const mm = String(m).padStart(2, "0");
      const ss = String(s).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }

    function minutesToTimeString(mins) {
      if (mins == null) return "--:--";
      const wrapped = ((mins % (24 * 60)) + 24 * 60) % (24 * 60);
      const h = Math.floor(wrapped / 60);
      const m = wrapped % 60;
      return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
    }

    function copingApproxText(mins, cooked) {
      if (mins <= 0) return cooked ? "Clock says done. Brain can leave the building now." : "You‚Äôre done. Mentally at least.";

      if (cooked) {
        // extra soft for cooked mode
        if (mins <= 30) return "Cooked mode: just ride out these last few minutes on autopilot.";
        if (mins <= 60) return "Cooked mode: treat this as under an hour of background noise.";
        return "Cooked mode: you‚Äôve already done the important part. Now you‚Äôre waiting for the clock to catch up.";
      }

      if (mins < 15) return "Feels like: basically no time at all.";
      if (mins < 30) return "Feels like: less than half an episode.";
      if (mins < 60) return "Feels like: under an hour.";
      if (mins < 90) return "Feels like: a bit more than an hour.";
      if (mins < 180) return "Feels like: a couple of hours-ish.";
      if (mins < 240) return "Feels like: a few hours, but you‚Äôve eaten a chunk of it already.";
      return "Feels like: a handful of hours. Not forever, even if it‚Äôs annoying.";
    }

    function phaseFromPct(pct) {
      if (pct <= 0) return "";
      if (pct < 25) return "You showed up. Hardest part is already done.";
      if (pct < 50) return "You cleared the intro. You‚Äôre in the middle chunk now.";
      if (pct < 75) return "You‚Äôve passed halfway. You‚Äôre closer to home than to morning.";
      if (pct < 90) return "Last stretch. This is cleanup, not heavy lifting.";
      if (pct < 100) return "Final minutes. You‚Äôre basically a ghost in the system.";
      return "Shift complete. Everything else is voluntary suffering.";
    }

    function todayString() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function calcWaterGoal(totalMinutes) {
      const hours = totalMinutes / 60;
      if (hours <= 4) return 3;
      if (hours <= 6) return 4;
      if (hours <= 8) return 5;
      return 6;
    }

    // --------- STORAGE ---------

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        state = { ...state, ...parsed };
      } catch (e) {
        console.warn("Failed to load saved state", e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        // ignore
      }
    }

    // --------- SHIFT INFO ---------

    function computeShiftInfo() {
      const startStr = state.shift.start;
      const endStr = state.shift.end;

      const startM = parseTimeToMinutes(startStr);
      const endRaw = parseTimeToMinutes(endStr);

      if (startM == null || endRaw == null) {
        return { valid: false, error: "Please set both shift start and end times." };
      }

      let endM = endRaw;
      if (endM <= startM) {
        endM += 24 * 60; // overnight
      }
      const total = endM - startM;
      if (total <= 0) {
        return {
          valid: false,
          error: "Shift length looks like 0. Manifesting that for you, but cannot calculate it."
        };
      }

      const nowRaw = getCurrentMinutes();
      let nowM = nowRaw;
      if (nowM < startM && endM > 24 * 60) {
        nowM += 24 * 60;
      }

      const elapsed = clamp(nowM - startM, 0, total);
      const remaining = clamp(total - elapsed, 0, total);
      const pct = total === 0 ? 0 : (elapsed / total) * 100;

      // auto water goal derived from shift
      const newGoal = calcWaterGoal(total);
      if (newGoal !== state.settings.waterGoal) {
        state.settings.waterGoal = newGoal;
        saveState();
      }

      return {
        valid: true,
        startM,
        endM,
        total,
        elapsed,
        remaining,
        pct
      };
    }

    // --------- COMPARISONS ---------

    function buildComparisons(total, remaining) {
      const listEl = document.getElementById("comparison-list");
      listEl.innerHTML = "";
      if (total <= 0 || remaining <= 0) {
        return;
      }

      const ratio = remaining / total;
      const lines = [];

      function unitText(label, minutesPer) {
        let count = Math.floor(remaining / minutesPer);
        if (count < 1) count = 1;
        return `${count} ${label}${count === 1 ? "" : "s"}`;
      }

      if (ratio > 0.6) {
        // early shift: chunky cozy stuff
        lines.push(
          "If this were a bakery shift, that‚Äôs about " + unitText("cinnamon roll batch", 90) + "."
        );
        lines.push(
          "In art time, that‚Äôs roughly " + unitText("long drawing session", 40) + "."
        );
        lines.push(
          "In playlist time, that‚Äôs like " + unitText("full cozy playlist", 45) + "."
        );
      } else if (ratio > 0.3) {
        // middle chunk
        lines.push(
          "In anime units, that‚Äôs about " + unitText("episode", 24) + "."
        );
        lines.push(
          "That‚Äôs like " + unitText("‚ÄòI‚Äôll just scroll a bit‚Äô segment", 12) + "."
        );
        lines.push(
          "In bus rides, that‚Äôs around " + unitText("short commute", 20) + "."
        );
      } else {
        // last part: tiny, ‚Äúyou‚Äôre almost out‚Äù
        lines.push(
          "Your shift ends in basically " + unitText("Love, Death & Robots episode", 15) + "."
        );
        lines.push(
          "Or like " + unitText("Starbucks run", 12) + "."
        );
        lines.push(
          "Or just " + unitText("bathroom scroll break", 5) + "."
        );
      }

      lines.forEach((line) => {
        const div = document.createElement("div");
        div.textContent = "‚Ä¢ " + line;
        listEl.appendChild(div);
      });
    }

    // --------- WATER HELPERS ---------

    function ensureWaterDate() {
      const today = todayString();
      if (state.water.date !== today) {
        state.water.date = today;
        state.water.count = 0;
        state.water.lastSipTs = null;
      }
    }

    function minsSince(ts) {
      if (!ts) return null;
      const diffMs = Date.now() - ts;
      if (diffMs < 0) return 0;
      return Math.floor(diffMs / 60000);
    }

    // --------- WEATHER ---------

    function weatherCodeToEmoji(code) {
      return WEATHER_CODE_EMOJI[code] || "üå°Ô∏è";
    }

    function weatherCodeToText(code) {
      return WEATHER_CODE_TEXT[code] || "weather doing its thing";
    }

    function updateWeatherUI() {
      const emojiEl = document.getElementById("weather-emoji");
      if (emojiEl) {
        emojiEl.textContent = weatherState.emoji || "--";
        emojiEl.title = weatherState.summary || "Weather loading";
      }

      const summaryEl = document.getElementById("weather-summary");
      if (summaryEl) summaryEl.textContent = weatherState.summary || "Peeking outside‚Ä¶";

      const todayEl = document.getElementById("weather-today");
      const tomorrowEl = document.getElementById("weather-tomorrow");

      if (todayEl) {
        const today = weatherState.today;
        todayEl.innerHTML = `<span>Today</span><span>${today ? today : "--"}</span>`;
      }
      if (tomorrowEl) {
        const tomorrow = weatherState.tomorrow;
        tomorrowEl.innerHTML = `<span>Tomorrow</span><span>${tomorrow ? tomorrow : "--"}</span>`;
      }
    }

    function processDailyWeather(daily, index) {
      if (!daily) return null;
      const weatherCodes = daily.weathercode || [];
      const maxArr = daily.temperature_2m_max || [];
      const minArr = daily.temperature_2m_min || [];
      const code = weatherCodes[index];
      const max = maxArr[index];
      const min = minArr[index];
      if (code == null || max == null || min == null) return null;
      const emoji = weatherCodeToEmoji(code);
      const desc = weatherCodeToText(code);
      return `${emoji} ${Math.round(min)}¬∞/${Math.round(max)}¬∞C ¬∑ ${desc}`;
    }

    function fetchWeather(lat, lon) {
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=3&timezone=auto`;
      fetch(url)
        .then((res) => res.json())
        .then((data) => {
          const currentWeather = data && data.current_weather ? data.current_weather : null;
          const currentCode = currentWeather ? currentWeather.weathercode : undefined;
          const currentTemp = currentWeather ? currentWeather.temperature : undefined;
          weatherState.emoji = weatherCodeToEmoji(currentCode);
          const tempText = typeof currentTemp === "number" ? `${Math.round(currentTemp)}¬∞C` : "mystery temps";
          weatherState.summary = currentCode
            ? `Now: ${weatherCodeToText(currentCode)} near ${tempText}`
            : "Window vibes unavailable.";
          weatherState.today = processDailyWeather(data.daily, 0);
          weatherState.tomorrow = processDailyWeather(data.daily, 1);
          updateWeatherUI();
        })
        .catch(() => {
          weatherState.summary = "Weather goblins napping. Try again later.";
          updateWeatherUI();
        });
    }

    function initWeatherWidget() {
      updateWeatherUI();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            fetchWeather(pos.coords.latitude, pos.coords.longitude);
          },
          () => {
            fetchWeather(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon);
          },
          { timeout: 5000 }
        );
      } else {
        fetchWeather(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon);
      }
    }

    // --------- RENDER: NOW TAB ---------

    function renderNowTab() {
      const countdownMain = document.getElementById("countdown-main");
      const countdownSub = document.getElementById("countdown-sub");
      const progressFill = document.getElementById("progress-fill");
      const progressMeta = document.getElementById("progress-meta");
      const anchorText = document.getElementById("anchor-text");
      const phaseText = document.getElementById("phase-text");
      const errorEl = document.getElementById("error-text");
      const unitsList = document.getElementById("units-list");
      const rewardLine = document.getElementById("reward-line");
      const summaryText = document.getElementById("summary-text");
      const nowWaterStrip = document.getElementById("now-water-strip");

      const info = computeShiftInfo();
      unitsList.innerHTML = "";
      anchorText.textContent = "";
      phaseText.textContent = "";
      errorEl.textContent = "";
      nowWaterStrip.textContent = "";

      if (!info.valid) {
        countdownMain.textContent = "--:--:--";
        countdownSub.textContent = info.error;
        progressFill.style.width = "0%";
        progressMeta.textContent = "Shift: -- | Done: -- | Left: --";
        rewardLine.textContent = "";
        summaryText.textContent = "Set your shift times to see your survival stats.";
        document.getElementById("comparison-list").innerHTML = "";
        renderNowWater(info); // will still show goal 0/0
        return;
      }

      const nowRaw = getCurrentMinutes();
      let nowM = nowRaw;
      if (nowM < info.startM && info.endM > 24 * 60) nowM += 24 * 60;

      const secondsTotal = info.total * 60;
      const secondsElapsed = clamp((nowM - info.startM) * 60, 0, secondsTotal);
      const secondsRemaining = clamp(secondsTotal - secondsElapsed, 0, secondsTotal);

      countdownMain.textContent = formatHMS(Math.round(secondsRemaining));
      const approx = copingApproxText(info.remaining, state.ui.cooked);
      countdownSub.textContent = approx;

      progressFill.style.width = Math.max(3, info.pct) + "%";
      progressMeta.textContent =
        `Shift: ${formatHM(info.total)} | Done: ${formatHM(info.elapsed)} | Left: ${formatHM(info.remaining)}`;

      phaseText.textContent = phaseFromPct(info.pct);

      if (info.remaining > 0) {
        const nextBreak = getUpcomingBreak(info, nowM);
        if (nextBreak) {
          anchorText.textContent = `Next stop: ‚òï ${nextBreak.label} in ${formatHM(nextBreak.diff)} (at ${
            nextBreak.time
          }).`;
        } else {
          anchorText.textContent = `Next stop: üè† home in ${formatHM(info.remaining)}.`;
        }
      } else {
        anchorText.textContent = "You‚Äôre free. At least, you should be.";
      }

      // water strip
      const goal = state.settings.waterGoal || 0;
      ensureWaterDate();
      const count = state.water.count;
      if (goal > 0) {
        nowWaterStrip.textContent = `Hydration side quest: ${count}/${goal} glasses logged.`;
      } else {
        nowWaterStrip.textContent = "";
      }

      // Units (shifted for cooked mode)
      let unitsSource = UNITS.slice();
      if (state.ui.cooked) {
        // only smallest survival units
        unitsSource.sort((a, b) => a.minutes - b.minutes);
        unitsSource = unitsSource.slice(0, 3);
      } else {
        const sortMode = state.ui.sortMode;
        unitsSource.sort((a, b) => {
          if (sortMode === "short") {
            return a.minutes - b.minutes;
          } else {
            return b.minutes - a.minutes;
          }
        });
      }

      unitsSource.forEach((u) => {
        const count = info.remaining / u.minutes;
        const row = document.createElement("div");
        row.className = "unit-row";

        const label = document.createElement("div");
        label.className = "unit-label";
        if (state.ui.cooked) {
          label.textContent = u.label.replace("Tiny brain breaks", "Tiny survival breaks");
        } else {
          label.textContent = u.label;
        }

        const val = document.createElement("div");
        val.className = "unit-value";
        const displayCount = Math.max(0, Math.round(count));
        val.textContent = displayCount;

        row.appendChild(label);
        row.appendChild(val);
        unitsList.appendChild(row);
      });

      // Reward line
      if (state.shift.reward && info.remaining > 0) {
        rewardLine.innerHTML =
          `Everything you‚Äôre doing now is for <strong>${state.shift.reward}</strong>. Time until that: ${formatHM(info.remaining)}.`;
      } else if (info.remaining > 0) {
        rewardLine.textContent =
          "Add one small thing you‚Äôll enjoy after work. Your brain likes having something to orbit.";
      } else {
        rewardLine.textContent = "Today‚Äôs shift is done. Future you can collapse now.";
      }

      const pctRounded = Math.round(info.pct);
      summaryLast = `You‚Äôve survived ${pctRounded}% of today‚Äôs shift (${formatHM(
        info.elapsed
      )} done, ${formatHM(info.remaining)} left).`;
      summaryText.textContent = summaryLast;

      // comparisons
      buildComparisons(info.total, info.remaining);

      // water mini bar
      renderNowWater(info);
    }

    function renderNowWater(shiftInfo) {
      ensureWaterDate();
      const goal = state.settings.waterGoal || 0;
      const count = state.water.count;
      const pct = goal > 0 ? Math.max(0, Math.min(100, (count / goal) * 100)) : 0;

      document.getElementById("now-water-count").textContent = count;
      document.getElementById("now-water-goal").textContent = goal;
      document.getElementById("now-water-fill").style.width = pct + "%";
    }

    // --------- SLACKING ---------

    function setSlackingError(msg) {
      const err = document.getElementById("slack-error");
      if (err) err.textContent = msg || "";
    }

    function renderSlackingWidget() {
      const listEl = document.getElementById("slack-list");
      if (!listEl) return;
      const breaks = state.slacking && state.slacking.breaks ? state.slacking.breaks.slice() : [];
      listEl.innerHTML = "";
      if (breaks.length === 0) {
        const empty = document.createElement("div");
        empty.className = "slack-empty";
        empty.textContent = "No secret breaks yet. Add one above.";
        listEl.appendChild(empty);
        return;
      }

      breaks.sort((a, b) => {
        const aM = parseTimeToMinutes(a.time) ?? 0;
        const bM = parseTimeToMinutes(b.time) ?? 0;
        return aM - bM;
      });

      breaks.forEach((item) => {
        const row = document.createElement("div");
        row.className = "slack-item";
        row.dataset.id = item.id;

        const meta = document.createElement("div");
        const label = document.createElement("div");
        label.className = "slack-item-label";
        label.textContent = item.label || "Unnamed break";
        const time = document.createElement("div");
        time.className = "slack-item-time";
        time.textContent = item.time || "--:--";
        meta.appendChild(label);
        meta.appendChild(time);

        const actions = document.createElement("div");
        actions.className = "slack-item-actions";

        const shuffleBtn = document.createElement("button");
        shuffleBtn.className = "tiny-icon-btn";
        shuffleBtn.type = "button";
        shuffleBtn.textContent = "üé≤";
        shuffleBtn.title = "Shuffle this break a little";
        shuffleBtn.dataset.action = "shuffle";
        shuffleBtn.dataset.id = item.id;

        const removeBtn = document.createElement("button");
        removeBtn.className = "tiny-icon-btn";
        removeBtn.type = "button";
        removeBtn.textContent = "‚àí";
        removeBtn.title = "Remove this break";
        removeBtn.dataset.action = "remove";
        removeBtn.dataset.id = item.id;

        actions.appendChild(shuffleBtn);
        actions.appendChild(removeBtn);

        row.appendChild(meta);
        row.appendChild(actions);
        listEl.appendChild(row);
      });
    }

    function addSlackBreak() {
      const labelInput = document.getElementById("slack-label");
      const timeInput = document.getElementById("slack-time");
      if (!labelInput || !timeInput) return;
      const label = labelInput.value.trim();
      const time = timeInput.value;
      if (!label || !time) {
        setSlackingError("Need both a label and time for your break.");
        return;
      }
      setSlackingError("");
      const newBreak = {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        label,
        time
      };
      if (!state.slacking) state.slacking = { breaks: [] };
      state.slacking.breaks.push(newBreak);
      labelInput.value = "";
      timeInput.value = "";
      saveState();
      renderSlackingWidget();
      renderNowTab();
    }

    function removeLastSlackBreak() {
      if (!state.slacking || !state.slacking.breaks || !state.slacking.breaks.length) {
        setSlackingError("No breaks to remove.");
        return;
      }
      setSlackingError("");
      state.slacking.breaks.pop();
      saveState();
      renderSlackingWidget();
      renderNowTab();
    }

    function removeSlackBreakById(id) {
      if (!state.slacking || !state.slacking.breaks) return;
      state.slacking.breaks = state.slacking.breaks.filter((b) => b.id !== id);
      saveState();
      renderSlackingWidget();
      renderNowTab();
    }

    function shuffleSlackBreak(id) {
      if (!state.slacking || !state.slacking.breaks) return;
      const item = state.slacking.breaks.find((b) => b.id === id);
      if (!item) return;
      const original = parseTimeToMinutes(item.time);
      if (original == null) return;
      let delta = Math.floor(Math.random() * 7) - 3; // -3..3
      if (delta === 0) delta = 1;
      let newMins = original + delta;
      if (newMins < 0) newMins = 0;
      if (newMins >= 24 * 60) newMins = 24 * 60 - 1;
      item.time = minutesToTimeString(newMins);
      saveState();
      renderSlackingWidget();
      renderNowTab();
    }

    function getUpcomingBreak(info, nowM) {
      if (!info || !state.slacking || !state.slacking.breaks || !state.slacking.breaks.length) return null;
      const shiftStartModulo = info.startM % (24 * 60);
      let best = null;
      state.slacking.breaks.forEach((b) => {
        const mins = parseTimeToMinutes(b.time);
        if (mins == null) return;
        let absolute = mins;
        if (info.endM > 24 * 60 && mins < shiftStartModulo) {
          absolute += 24 * 60;
        }
        if (absolute < nowM || absolute > info.endM) return;
        const diff = absolute - nowM;
        if (diff < 0) return;
        if (!best || diff < best.diff) {
          best = { label: b.label, time: minutesToTimeString(absolute), diff };
        }
      });
      return best;
    }

    // --------- RENDER: SURVIVAL TAB ---------

    function pickNextQuote() {
      const tone = state.settings.tone || "soft";
      const pool = QUOTES[tone] || QUOTES.soft;
      if (quoteIndex >= pool.length) quoteIndex = 0;
      const text = pool[quoteIndex++];
      const qEl = document.getElementById("quote-text");
      const metaEl = document.getElementById("quote-meta");
      qEl.textContent = text;
      metaEl.textContent =
        `Tone: ${
          tone === "soft" ? "soft & gentle" : tone === "dark" ? "dark humor" : "blunt but kind"
        }.`;
    }

    function pickNextTip() {
      if (tipIndex >= TIPS.length) tipIndex = 0;
      const text = TIPS[tipIndex++];
      document.getElementById("tip-text").textContent = text;
    }

    function renderMood() {
      const mood = state.ui.mood;
      const moodButtons = document.querySelectorAll(".mood-btn");
      moodButtons.forEach((btn) => {
        if (btn.dataset.mood === mood) btn.classList.add("active");
        else btn.classList.remove("active");
      });
      document.getElementById("mood-msg").textContent = MOOD_MESSAGES[mood] || "";
    }

    function renderWater() {
      ensureWaterDate();
      const count = state.water.count;
      const goal = state.settings.waterGoal || 0;
      const pct = goal > 0 ? Math.max(0, Math.min(100, (count / goal) * 100)) : 0;
      document.getElementById("water-count").textContent = count;
      document.getElementById("water-goal").textContent = goal;
      document.getElementById("water-fill").style.width = pct + "%";

      const metaEl = document.getElementById("water-meta");
      const since = minsSince(state.water.lastSipTs);
      let timeLine = "";

      if (since == null) {
        timeLine = "No sips logged yet today.";
      } else if (since < 45) {
        timeLine = `Last water: ~${since} min ago. Hydrated brain supremacy.`;
      } else {
        timeLine = `It‚Äôs been about ${since} min since your last sip. If you can, refill.`;
      }

      let msg;
      if (count === 0) msg = "First sip of the day is always the best. Consider this your sign.";
      else if (goal > 0 && count < goal)
        msg = "Nice. Tiny hydration is still hydration. No guilt if you forget sometimes.";
      else if (goal > 0 && count >= goal)
        msg = "Hydrated legend. Anything beyond this is bonus DLC.";
      else msg = "";

      metaEl.textContent = `${timeLine} ${msg}`.trim();
    }

    function renderStatusPill() {
      const pill = document.getElementById("status-pill");
      const textEl = document.getElementById("status-text");
      if (state.ui.cooked) {
        pill.querySelector("span").textContent = "üç≥";
        textEl.textContent = "Status: cooked";
      } else if (state.ui.mood === "tired") {
        pill.querySelector("span").textContent = "üòë";
        textEl.textContent = "Status: tired but here";
      } else if (state.ui.mood === "ok") {
        pill.querySelector("span").textContent = "üòå";
        textEl.textContent = "Status: present";
      } else {
        pill.querySelector("span").textContent = "üôÇ";
        textEl.textContent = "Status: here-ish";
      }
    }

    function renderCookButton() {
      const cookBtn = document.getElementById("cook-btn");
      if (!cookBtn) return;
      if (state.ui.cooked) {
        cookBtn.innerHTML = "<span>üßä</span><span>Bring me back, I guess</span>";
      } else {
        cookBtn.innerHTML = "<span>üç≥</span><span>I‚Äôm mentally clocked out</span>";
      }
    }

    function pickReminder() {
      if (reminderIndex >= REMINDERS.length) reminderIndex = 0;
      const text = REMINDERS[reminderIndex++];
      document.getElementById("reminder-text").textContent = text;
    }

    // --------- SETTINGS RENDER ---------

    function applySettingsToUI() {
      // Tone radios
      const toneRadios = document.querySelectorAll('input[name="tone"]');
      toneRadios.forEach((r) => {
        r.checked = r.value === state.settings.tone;
      });

      // Animations
      document.getElementById("toggle-animations").checked =
        state.settings.animations === false ? true : false;
      if (state.settings.animations === false) {
        document.body.classList.add("no-animations");
      } else {
        document.body.classList.remove("no-animations");
      }

      // Shift inputs
      document.getElementById("start-time").value = state.shift.start;
      document.getElementById("end-time").value = state.shift.end;
      document.getElementById("reward-text").value = state.shift.reward || "";
    }

    // --------- EVENTS & INIT ---------

    function initEvents() {
      // Tabs
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          tabContents.forEach((c) => {
            if (c.id === "tab-" + target) c.classList.add("active");
            else c.classList.remove("active");
          });
        });
      });

      // Recalculate
      document.getElementById("recalc-btn").addEventListener("click", () => {
        const startVal = document.getElementById("start-time").value;
        const endVal = document.getElementById("end-time").value;
        const rewardVal = document.getElementById("reward-text").value.trim();

        state.shift.start = startVal || "09:00";
        state.shift.end = endVal || "17:00";
        state.shift.reward = rewardVal;
        saveState();
        renderNowTab();
        renderWater();
      });

      // water quick-add on Now tab
      document.getElementById("now-water-add-btn").addEventListener("click", () => {
        ensureWaterDate();
        state.water.count += 1;
        state.water.lastSipTs = Date.now();
        saveState();
        renderNowTab();
        renderWater();
      });

      // Sort units
      document.getElementById("sort-short").addEventListener("click", () => {
        state.ui.sortMode = "short";
        document.getElementById("sort-short").classList.add("active");
        document.getElementById("sort-long").classList.remove("active");
        saveState();
        renderNowTab();
      });
      document.getElementById("sort-long").addEventListener("click", () => {
        state.ui.sortMode = "long";
        document.getElementById("sort-long").classList.add("active");
        document.getElementById("sort-short").classList.remove("active");
        saveState();
        renderNowTab();
      });

      // Quotes & tips
      document.getElementById("quote-next-btn").addEventListener("click", () => {
        pickNextQuote();
      });

      document.getElementById("tip-next-btn").addEventListener("click", () => {
        pickNextTip();
      });

      // Mood buttons
      const moodButtons = document.querySelectorAll(".mood-btn");
      moodButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          state.ui.mood = btn.dataset.mood;
          saveState();
          renderMood();
          renderStatusPill();
          renderNowTab();
        });
      });

      // Water (survival tab)
      document.getElementById("water-add-btn").addEventListener("click", () => {
        ensureWaterDate();
        state.water.count += 1;
        state.water.lastSipTs = Date.now();
        saveState();
        renderWater();
        renderNowTab();
      });

      // Cooked mode
      const cookBtn = document.getElementById("cook-btn");
      cookBtn.addEventListener("click", () => {
        state.ui.cooked = !state.ui.cooked;
        saveState();
        renderStatusPill();
        renderCookButton();
        renderNowTab();
        const modal = document.getElementById("cook-modal");
        if (state.ui.cooked) {
          modal.style.display = "flex";
        } else {
          modal.style.display = "none";
        }
      });
      document.getElementById("cook-dismiss").addEventListener("click", () => {
        document.getElementById("cook-modal").style.display = "none";
      });

      // Slacking inputs
      document.getElementById("slack-add-btn").addEventListener("click", addSlackBreak);
      document.getElementById("slack-remove-btn").addEventListener("click", removeLastSlackBreak);
      document.getElementById("slack-list").addEventListener("click", (e) => {
        const target = e.target;
        if (!target || !target.dataset) return;
        const action = target.dataset.action;
        const id = target.dataset.id;
        if (!action || !id) return;
        if (action === "remove") removeSlackBreakById(id);
        if (action === "shuffle") shuffleSlackBreak(id);
      });

      // Settings: tone
      document.querySelectorAll('input[name="tone"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          state.settings.tone = radio.value;
          saveState();
          pickNextQuote();
        });
      });

      // Settings: animations
      document.getElementById("toggle-animations").addEventListener("change", (e) => {
        const disabled = e.target.checked;
        state.settings.animations = !disabled;
        saveState();
        if (disabled) {
          document.body.classList.add("no-animations");
        } else {
          document.body.classList.remove("no-animations");
        }
      });
    }

    function init() {
      loadState();

      // Ensure defaults for missing fields
      state = {
        ...DEFAULT_STATE,
        ...state,
        settings: { ...DEFAULT_STATE.settings, ...(state.settings || {}) },
        shift: { ...DEFAULT_STATE.shift, ...(state.shift || {}) },
        water: { ...DEFAULT_STATE.water, ...(state.water || {}) },
        slacking: { ...DEFAULT_STATE.slacking, ...(state.slacking || {}) },
        ui: { ...DEFAULT_STATE.ui, ...(state.ui || {}) }
      };

      applySettingsToUI();
      ensureWaterDate();
      initEvents();

      shuffleArray(REMINDERS);
      shuffleArray(TIPS);

      renderNowTab();
      pickNextQuote();
      pickNextTip();
      renderMood();
      renderWater();
      renderStatusPill();
      renderCookButton();
      renderSlackingWidget();
      pickReminder();
      initWeatherWidget();

      setInterval(() => {
        renderNowTab();
        renderWater(); // keeps ‚Äúsince last sip‚Äù and goal in sync
      }, 1000);
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
