<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shift Time Bakery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;700&family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #f3e2c7;
      --frame-bg: #fdf7ec;
      --frame-border: #c69b63;
      --card-bg: #fffbf5;
      --card-border: #e7c5a1;
      --accent: #e58b55;
      --accent-dark: #b46339;
      --text-main: #3d2819;
      --text-soft: #806152;
      --chip-bg: #ffe0bd;
      --chip-border: #f3b58a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "M PLUS Rounded 1c", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: var(--bg-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }

    body.no-animations *,
    body.no-animations *::before,
    body.no-animations *::after {
      transition: none !important;
      animation: none !important;
    }

    /* Fixed window frame */

    .app-frame {
      width: 960px;
      max-width: 100%;
      max-height: 640px;
      background: var(--frame-bg);
      border: 3px solid var(--frame-border);
      box-shadow:
        0 0 0 3px #f9e3b8,
        0 12px 32px rgba(0, 0, 0, 0.25);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    @media (max-width: 720px) {
      .app-frame {
        max-height: none;
        height: auto;
      }
    }

    .app-frame-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 4px 4px;
      border-bottom: 2px solid #e4c38b;
      font-size: 0.7rem;
    }

    .topbar-title {
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.06em;
    }

    .topbar-dots {
      display: flex;
      gap: 4px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 0;
      border: 2px solid #8b5a2b;
      background: #ffe7b3;
    }

    .dot:nth-child(2) {
      background: #ffbe8e;
    }
    .dot:nth-child(3) {
      background: #f48d62;
    }

    .app {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.2fr);
      gap: 8px;
      overflow: hidden;
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: minmax(0, 1fr);
        max-height: none;
      }
    }

    .panel {
      background: var(--card-bg);
      border-radius: 8px;
      border: 2px solid var(--card-border);
      padding: 10px 10px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    /* Left: main / tabs */

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-subtitle {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .status-pill {
      font-size: 0.68rem;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid #f2c89c;
      background: #fff2de;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .status-pill span {
      font-size: 0.9rem;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      border-bottom: 1px solid #f0d6b8;
      padding-bottom: 4px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      font-size: 0.72rem;
      padding: 4px 8px;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-soft);
    }

    .tab-btn.active {
      color: var(--accent-dark);
      background: #ffe9d1;
      border: 1px solid #f2c89c;
    }

    .tab-scroll {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .tab-content {
      display: none;
      font-size: 0.8rem;
    }

    .tab-content.active {
      display: block;
    }

    /* Inputs area */

    .inputs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .field {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    label {
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    input[type="time"],
    input[type="text"] {
      background: #fff4e6;
      border: 1px solid #e1c2a7;
      border-radius: 4px;
      padding: 4px 6px;
      font: inherit;
      color: var(--text-main);
    }

    input[type="time"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px #ffd9b8;
    }

    .btn-main {
      margin-top: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 2px solid var(--accent-dark);
      background: repeating-linear-gradient(
        -45deg,
        #ffcf9f,
        #ffcf9f 3px,
        #ffc390 3px,
        #ffc390 6px
      );
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent-dark);
      cursor: pointer;
      width: 100%;
    }

    .btn-main:active {
      transform: translateY(1px);
      box-shadow: inset 0 0 0 2px rgba(165, 83, 44, 0.3);
    }

    .error-text {
      font-size: 0.7rem;
      color: #b30000;
      margin-top: 4px;
      min-height: 14px;
    }

    /* Cards */

    .card {
      background: #fffaf2;
      border-radius: 6px;
      border: 1px solid #f1d2ac;
      padding: 8px 8px 6px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.75rem;
      color: #b07a5f;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .countdown-main {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .countdown-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: #ffe8cf;
      border-radius: 999px;
      border: 1px solid #e6c09e;
      overflow: hidden;
      position: relative;
      margin-bottom: 4px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #f39f5a, #f7c46a);
      transition: width 0.3s ease-out;
    }

    .progress-meta {
      font-size: 0.74rem;
      color: var(--text-soft);
    }

    .anchor-text {
      font-size: 0.76rem;
      margin-top: 2px;
      color: var(--text-soft);
    }

    .phase-text {
      font-size: 0.76rem;
      margin-top: 2px;
      color: var(--text-soft);
      font-style: italic;
    }

    /* Units */

    .units-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .sort-btns {
      display: inline-flex;
      gap: 3px;
    }

    .sort-btn {
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      padding: 2px 6px;
      cursor: pointer;
      color: var(--text-soft);
    }

    .sort-btn.active {
      background: #ffe3c0;
      color: var(--accent-dark);
    }

    .units-list {
      display: grid;
      gap: 3px;
      font-size: 0.78rem;
    }

    .unit-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .unit-label {
      color: var(--text-soft);
    }

    .unit-value {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      color: var(--accent-dark);
    }

    .reward-line {
      font-size: 0.78rem;
      margin-top: 4px;
      color: var(--text-soft);
    }

    .reward-line strong {
      color: var(--text-main);
    }

    /* Right panel */

    .side-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #b07a5f;
      margin-bottom: 4px;
    }

    .quote-text {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .small-btn {
      font-size: 0.72rem;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      cursor: pointer;
      color: var(--text-soft);
    }

    .small-btn:active {
      transform: translateY(1px);
    }

    .inline-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .tip-text {
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .mood-row {
      display: flex;
      gap: 6px;
      margin: 4px 0;
    }

    .mood-btn {
      flex: 1;
      font-size: 0.78rem;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .mood-btn.active {
      background: #ffe3c0;
      border-color: var(--accent);
    }

    .mood-msg {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .water-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin: 4px 0;
    }

    .water-count {
      font-size: 0.8rem;
    }

    .water-bar {
      width: 100%;
      height: 8px;
      background: #ffe8cf;
      border-radius: 999px;
      border: 1px solid #e6c09e;
      overflow: hidden;
      margin-top: 3px;
    }

    .water-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #60a5fa, #93c5fd);
      transition: width 0.3s ease-out;
    }

    .water-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .cook-btn {
      width: 100%;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px dashed #f2b199;
      background: #fff2ec;
      font-size: 0.78rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--accent-dark);
    }

    .cook-btn:active {
      transform: translateY(1px);
    }

    /* Settings */

    .settings-group {
      margin-bottom: 8px;
    }

    .settings-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #b07a5f;
      margin-bottom: 2px;
    }

    .settings-option-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 2px;
      font-size: 0.78rem;
    }

    .settings-hint {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .modal {
      background: #fffaf2;
      border-radius: 8px;
      border: 2px solid #f2b199;
      padding: 10px 12px;
      max-width: 320px;
      width: calc(100% - 32px);
      font-size: 0.82rem;
    }

    .modal-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .modal-btn {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #f1d2ac;
      background: #fff5e7;
      cursor: pointer;
    }

    .modal-btn.primary {
      border-color: var(--accent-dark);
      background: #ffe3c0;
      color: var(--accent-dark);
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <div class="app-frame-topbar">
      <div class="topbar-title">SHIFT TIME BAKERY.exe</div>
      <div class="topbar-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>

    <div class="app">
      <!-- Left: main / tabs -->
      <div class="panel">
        <div class="header">
          <div class="title-block">
            <div class="app-subtitle">lofi shift survival, not productivity</div>
          </div>
          <div class="status-pill" id="status-pill">
            <span>üôÇ</span><span id="status-text">Status: present</span>
          </div>
        </div>

        <div class="tabs">
          <button class="tab-btn active" data-tab="now">Now</button>
          <button class="tab-btn" data-tab="survival">Survival Kit</button>
          <button class="tab-btn" data-tab="settings">Settings</button>
        </div>

        <div class="tab-scroll">
          <!-- TAB: NOW -->
          <div class="tab-content active" id="tab-now">
            <div class="inputs-row">
              <div class="field">
                <label for="start-time">Shift start</label>
                <input type="time" id="start-time" value="09:00" />
              </div>
              <div class="field">
                <label for="end-time">Shift end</label>
                <input type="time" id="end-time" value="17:00" />
              </div>
              <div class="field">
                <label for="reward-text">After work I‚Äôll‚Ä¶ (optional)</label>
                <input type="text" id="reward-text" placeholder="play games / draw / do nothing" />
              </div>
            </div>
            <button class="btn-main" id="recalc-btn">Recalculate my suffering</button>
            <div class="error-text" id="error-text"></div>

            <div class="card">
              <div class="card-title">Countdown</div>
              <div class="countdown-main" id="countdown-main">--:--:--</div>
              <div class="countdown-sub" id="countdown-sub">Set your shift times to begin.</div>

              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="progress-meta" id="progress-meta">Shift: -- | Done: -- | Left: --</div>
              <div class="phase-text" id="phase-text"></div>
              <div class="anchor-text" id="anchor-text"></div>
            </div>

            <div class="card">
              <div class="units-header">
                <div class="card-title">Remaining time in tiny units</div>
                <div class="sort-btns">
                  <button class="sort-btn active" id="sort-short">Shortest first</button>
                  <button class="sort-btn" id="sort-long">Biggest first</button>
                </div>
              </div>
              <div class="units-list" id="units-list"></div>
              <div class="reward-line" id="reward-line"></div>
            </div>
          </div>

          <!-- TAB: SURVIVAL -->
          <div class="tab-content" id="tab-survival">
            <div class="card">
              <div class="side-section-title">Support quote</div>
              <div class="quote-text" id="quote-text"></div>
              <button class="small-btn" id="quote-next-btn">New quote</button>
              <div class="inline-meta" id="quote-meta"></div>
            </div>

            <div class="card">
              <div class="side-section-title">Legal slacking & survival ideas</div>
              <div class="tip-text" id="tip-text"></div>
              <button class="small-btn" id="tip-next-btn">Show another</button>
            </div>

            <div class="card">
              <div class="side-section-title">How cooked are you?</div>
              <div class="mood-row">
                <button class="mood-btn active" data-mood="ok"><span>üòå</span><span>okay</span></button>
                <button class="mood-btn" data-mood="tired"><span>üòë</span><span>tired</span></button>
                <button class="mood-btn" data-mood="cooked"><span>üòµ</span><span>cooked</span></button>
              </div>
              <div class="mood-msg" id="mood-msg"></div>
            </div>

            <div class="card">
              <div class="side-section-title">Water check</div>
              <div class="water-row">
                <div class="water-count">
                  <span id="water-count">0</span>/<span id="water-goal">5</span> glasses this shift
                </div>
                <button class="small-btn" id="water-add-btn">I drank water üíß</button>
              </div>
              <div class="water-bar">
                <div class="water-fill" id="water-fill"></div>
              </div>
              <div class="water-meta" id="water-meta"></div>
            </div>

            <button class="cook-btn" id="cook-btn">
              <span>üç≥</span>
              <span>I‚Äôm mentally clocked out</span>
            </button>
          </div>

          <!-- TAB: SETTINGS -->
          <div class="tab-content" id="tab-settings">
            <div class="settings-group">
              <div class="settings-title">Support tone</div>
              <div class="settings-option-row">
                <label><input type="radio" name="tone" value="soft" checked> Soft & gentle</label>
              </div>
              <div class="settings-option-row">
                <label><input type="radio" name="tone" value="dark"> Dark humor</label>
              </div>
              <div class="settings-option-row">
                <label><input type="radio" name="tone" value="blunt"> Blunt but kind</label>
              </div>
            </div>

            <div class="settings-group">
              <div class="settings-title">Visual comfort</div>
              <label><input type="checkbox" id="toggle-animations"> Disable animations / smooth transitions</label>
              <div class="settings-hint">For motion sensitivity or if you just like it snappy.</div>
            </div>

            <div class="settings-group">
              <div class="settings-title">Future stuff</div>
              <div class="settings-hint">
                Themes (rainy city, night konbini) and ‚Äúoffice mode‚Äù will live here later.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right panel -->
      <div class="panel">
        <div class="side-section-title">Today in the bakery</div>
        <div style="font-size:0.8rem; color:var(--text-soft); margin-bottom:8px;">
          This little dashboard is here to remind you there is more to life than this shift.
          You‚Äôre not your productivity. You‚Äôre just a tired person in a cute fake .exe window.
        </div>

        <div class="card">
          <div class="side-section-title">Quick summary</div>
          <div id="summary-text" style="font-size:0.8rem;"></div>
        </div>

        <div class="card">
          <div class="side-section-title">Tiny reminder</div>
          <div style="font-size:0.8rem;" id="reminder-text"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cooked modal -->
  <div class="modal-backdrop" id="cook-modal">
    <div class="modal">
      <div class="modal-title">Cooked mode: ON</div>
      <div id="cook-modal-body">
        Your brain has officially clocked out. For the rest of this shift, bare-minimum mode is valid:
        <ul>
          <li>Do only what‚Äôs genuinely urgent.</li>
          <li>Say ‚ÄúI‚Äôll get back to this later‚Äù more often.</li>
          <li>Automatically forgive yourself for being slow.</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="cook-dismiss">Ok, I‚Äôll coast</button>
      </div>
    </div>
  </div>

  <script>
    // --------- STATE & CONSTANTS ---------

    const STORAGE_KEY = "shiftTimeBakeryState_v2";

    const DEFAULT_STATE = {
      settings: {
        tone: "soft",
        animations: true,
        waterGoal: 5
      },
      shift: {
        start: "09:00",
        end: "17:00",
        reward: ""
      },
      water: {
        date: null,
        count: 0,
        lastSipTs: null
      },
      ui: {
        sortMode: "short",
        mood: "ok",
        cooked: false
      }
    };

    let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

    const QUOTES = {
      soft: [
        "Being autistic at work is hard mode. You‚Äôre doing more than enough just by existing here.",
        "You are not your productivity. Surviving this shift is already a lot.",
        "You‚Äôre not behind in life. You‚Äôre just tired and doing your best in a loud world.",
        "It‚Äôs okay if your brain wandered today. That‚Äôs not failure, that‚Äôs coping."
      ],
      dark: [
        "You didn‚Äôt choose the grindset. The grindset chose you. You‚Äôre allowed to opt out mentally.",
        "Late stage capitalism speedrun: survive today, complain about it later online.",
        "Your brain is a premium limited-edition item. This job is on a free trial.",
        "They‚Äôre paying for your time, not your soul. Keep the soul."
      ],
      blunt: [
        "You are not the problem. The environment is not built for your nervous system.",
        "You‚Äôre not lazy. You‚Äôre overloaded. There‚Äôs a difference.",
        "Masking for 8 hours is a full-time job on top of your full-time job.",
        "You are allowed to want more than this. That doesn‚Äôt make you ungrateful."
      ]
    };

    const TIPS = [
      "Micro-break: stare at something at least 5 meters away for 20 seconds. Eyes and brain both reset.",
      "Write down one thing that‚Äôs bothering you about work. You don‚Äôt have to fix it, just park it.",
      "Change your posture for 30 seconds: roll your shoulders, unclench your jaw, wiggle your toes.",
      "If a task feels impossible, break it into the smallest step you can think of and only commit to that.",
      "Lower your screen brightness a little if you can. Your nervous system will say thank you.",
      "Make a tiny plan for after work: one small nice thing. Your brain likes having something to orbit.",
      "If masking is heavy, reduce it by just 5% for the next 10 minutes. You don‚Äôt have to be perfect."
    ];

    const MOOD_MESSAGES = {
      ok: "Nice. Use some of that energy to be kind to Future-You, not just the job.",
      tired: "You‚Äôre allowed to coast. 70% effort is still effort.",
      cooked: "Minimum viable human mode: unlocked. Bare minimum is okay for now."
    };

    const REMINDERS = [
      "You are not a machine. You are a person doing their best in weird circumstances.",
      "There is a version of your life after this job. You‚Äôre allowed to walk toward it slowly.",
      "Doing less than your theoretical maximum is still valid. You‚Äôre not a productivity app.",
      "Your worth is not measured in emails answered or tasks completed."
    ];

    const UNITS = [
      { label: "Lo-fi tracks (3 min)", minutes: 3 },
      { label: "Tea distractions (5 min)", minutes: 5 },
      { label: "Window-staring loops (90 sec)", minutes: 1.5 },
      { label: "Tiny brain breaks (30 sec)", minutes: 0.5 },
      { label: "Imaginary bakery doodles (7 min)", minutes: 7 },
      { label: "Scrolling sessions (2 min)", minutes: 2 }
    ];

    let quoteIndex = 0;
    let tipIndex = 0;
    let reminderIndex = 0;
    let summaryLast = "";

    // --------- UTIL ---------

    function parseTimeToMinutes(timeStr) {
      if (!timeStr) return null;
      const [h, m] = timeStr.split(":").map(Number);
      if (Number.isNaN(h) || Number.isNaN(m)) return null;
      return h * 60 + m;
    }

    function getCurrentMinutes() {
      const now = new Date();
      return now.getHours() * 60 + now.getMinutes();
    }

    function clamp(num, min, max) {
      return Math.min(Math.max(num, min), max);
    }

    function formatHM(mins) {
      if (mins == null) return "--";
      const sign = mins < 0 ? "-" : "";
      const abs = Math.abs(mins);
      const h = Math.floor(abs / 60);
      const m = abs % 60;
      if (h === 0) return sign + m + " min";
      return sign + h + "h " + m + "m";
    }

    function formatHMS(seconds) {
      if (seconds < 0) seconds = 0;
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      const hh = String(h).padStart(2, "0");
      const mm = String(m).padStart(2, "0");
      const ss = String(s).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }

    function approxTextFromMinutes(mins) {
      if (mins <= 0) return "You‚Äôre done. Mentally at least.";
      const hours = mins / 60;
      if (hours < 1) {
        const minutesRounded = Math.max(5, Math.round(mins / 5) * 5);
        return `About ${minutesRounded} minutes left.`;
      } else {
        const approx = Math.round(hours * 10) / 10;
        if (approx === 1) return "About 1 hour left.";
        return `About ${approx} hours left.`;
      }
    }

    function phaseFromPct(pct) {
      if (pct <= 0) return "";
      if (pct < 25) return "Phase: opening act / warm-up suffering.";
      if (pct < 60) return "Phase: middle stretch, the blur zone.";
      if (pct < 85) return "Phase: last big hill.";
      if (pct < 100) return "Phase: final boss ‚Äî pretending to care.";
      return "Phase: post-credits scene. You‚Äôre free.";
    }

    function todayString() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // --------- STORAGE ---------

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        state = { ...state, ...parsed };
      } catch (e) {
        console.warn("Failed to load saved state", e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        // ignore
      }
    }

    // --------- RENDER: NOW TAB ---------

    function computeShiftInfo() {
      const startStr = state.shift.start;
      const endStr = state.shift.end;

      const startM = parseTimeToMinutes(startStr);
      const endRaw = parseTimeToMinutes(endStr);

      if (startM == null || endRaw == null) {
        return { valid: false, error: "Please set both shift start and end times." };
      }

      let endM = endRaw;
      if (endM <= startM) {
        endM += 24 * 60; // overnight
      }
      const total = endM - startM;
      if (total <= 0) {
        return {
          valid: false,
          error: "Shift length looks like 0. Manifesting that for you, but cannot calculate it."
        };
      }

      const nowRaw = getCurrentMinutes();
      let nowM = nowRaw;
      if (nowM < startM && endM > 24 * 60) {
        nowM += 24 * 60;
      }

      const elapsed = clamp(nowM - startM, 0, total);
      const remaining = clamp(total - elapsed, 0, total);
      const pct = total === 0 ? 0 : (elapsed / total) * 100;

      return {
        valid: true,
        startM,
        endM,
        total,
        elapsed,
        remaining,
        pct
      };
    }

    function renderNowTab() {
      const countdownMain = document.getElementById("countdown-main");
      const countdownSub = document.getElementById("countdown-sub");
      const progressFill = document.getElementById("progress-fill");
      const progressMeta = document.getElementById("progress-meta");
      const anchorText = document.getElementById("anchor-text");
      const phaseText = document.getElementById("phase-text");
      const errorEl = document.getElementById("error-text");
      const unitsList = document.getElementById("units-list");
      const rewardLine = document.getElementById("reward-line");
      const summaryText = document.getElementById("summary-text");

      const info = computeShiftInfo();
      unitsList.innerHTML = "";
      anchorText.textContent = "";
      phaseText.textContent = "";
      errorEl.textContent = "";

      if (!info.valid) {
        countdownMain.textContent = "--:--:--";
        countdownSub.textContent = info.error;
        progressFill.style.width = "0%";
        progressMeta.textContent = "Shift: -- | Done: -- | Left: --";
        rewardLine.textContent = "";
        summaryText.textContent = "Set your shift times to see your survival stats.";
        return;
      }

      const nowRaw = getCurrentMinutes();
      let nowM = nowRaw;
      if (nowM < info.startM && info.endM > 24 * 60) nowM += 24 * 60;

      const secondsTotal = info.total * 60;
      const secondsElapsed = clamp((nowM - info.startM) * 60, 0, secondsTotal);
      const secondsRemaining = clamp(secondsTotal - secondsElapsed, 0, secondsTotal);

      countdownMain.textContent = formatHMS(Math.round(secondsRemaining));
      const approx = approxTextFromMinutes(info.remaining);
      countdownSub.textContent = approx;

      progressFill.style.width = Math.max(3, info.pct) + "%";
      progressMeta.textContent = `Shift: ${formatHM(info.total)} | Done: ${formatHM(info.elapsed)} | Left: ${formatHM(info.remaining)}`;

      phaseText.textContent = phaseFromPct(info.pct);

      if (info.remaining > 0) {
        anchorText.textContent = `Next stop: üè† home in ${formatHM(info.remaining)}.`;
      } else {
        anchorText.textContent = "You‚Äôre free. At least, you should be.";
      }

      // Units
      const sortMode = state.ui.sortMode;
      const unitsSorted = UNITS.slice().sort((a, b) => {
        if (sortMode === "short") {
          return a.minutes - b.minutes;
        } else {
          return b.minutes - a.minutes;
        }
      });

      unitsSorted.forEach((u) => {
        const count = info.remaining / u.minutes;
        const row = document.createElement("div");
        row.className = "unit-row";

        const label = document.createElement("div");
        label.className = "unit-label";
        label.textContent = u.label;

        const val = document.createElement("div");
        val.className = "unit-value";
        val.textContent = Math.max(0, Math.round(count));

        row.appendChild(label);
        row.appendChild(val);
        unitsList.appendChild(row);
      });

      // Reward line
      if (state.shift.reward && info.remaining > 0) {
        rewardLine.innerHTML = `Time until <strong>${state.shift.reward}</strong>: ${formatHM(info.remaining)}.`;
      } else if (info.remaining > 0) {
        rewardLine.textContent =
          "Add one small thing you‚Äôll enjoy after work. Your brain likes something to orbit.";
      } else {
        rewardLine.textContent = "Today‚Äôs shift is done. Future you can collapse now.";
      }

      const pctRounded = Math.round(info.pct);
      summaryLast = `You‚Äôve survived ${pctRounded}% of today‚Äôs shift (${formatHM(
        info.elapsed
      )} done, ${formatHM(info.remaining)} left).`;
      summaryText.textContent = summaryLast;
    }

    // --------- RENDER: SURVIVAL TAB ---------

    function pickNextQuote() {
      const tone = state.settings.tone || "soft";
      const pool = QUOTES[tone] || QUOTES.soft;
      if (quoteIndex >= pool.length) quoteIndex = 0;
      const text = pool[quoteIndex++];
      const qEl = document.getElementById("quote-text");
      const metaEl = document.getElementById("quote-meta");
      qEl.textContent = text;
      metaEl.textContent =
        `Tone: ${
          tone === "soft" ? "soft & gentle" : tone === "dark" ? "dark humor" : "blunt but kind"
        }.`;
    }

    function pickNextTip() {
      if (tipIndex >= TIPS.length) tipIndex = 0;
      const text = TIPS[tipIndex++];
      document.getElementById("tip-text").textContent = text;
    }

    function renderMood() {
      const mood = state.ui.mood;
      const moodButtons = document.querySelectorAll(".mood-btn");
      moodButtons.forEach((btn) => {
        if (btn.dataset.mood === mood) btn.classList.add("active");
        else btn.classList.remove("active");
      });
      document.getElementById("mood-msg").textContent = MOOD_MESSAGES[mood] || "";
    }

    function ensureWaterDate() {
      const today = todayString();
      if (state.water.date !== today) {
        state.water.date = today;
        state.water.count = 0;
        state.water.lastSipTs = null;
      }
    }

    function minsSince(ts) {
      if (!ts) return null;
      const diffMs = Date.now() - ts;
      if (diffMs < 0) return 0;
      return Math.floor(diffMs / 60000);
    }

    function renderWater() {
      ensureWaterDate();
      const count = state.water.count;
      const goal = state.settings.waterGoal || 5;
      const pct = Math.max(0, Math.min(100, (count / goal) * 100));
      document.getElementById("water-count").textContent = count;
      document.getElementById("water-goal").textContent = goal;
      document.getElementById("water-fill").style.width = pct + "%";

      const metaEl = document.getElementById("water-meta");
      const since = minsSince(state.water.lastSipTs);
      let timeLine = "";

      if (since == null) {
        timeLine = "No sips logged yet today.";
      } else if (since < 45) {
        timeLine = `Last water: ~${since} min ago. Hydrated brain supremacy.`;
      } else {
        timeLine = `It‚Äôs been about ${since} min since your last sip. If you can, refill.`;
      }

      let msg;
      if (count === 0) msg = "First sip of the day is always the best. Consider this your sign.";
      else if (count < goal)
        msg = "Nice. Tiny hydration is still hydration. No guilt if you forget sometimes.";
      else msg = "Hydrated legend. Anything beyond this is bonus DLC.";

      metaEl.textContent = `${timeLine} ${msg}`;
    }

    function renderStatusPill() {
      const pill = document.getElementById("status-pill");
      const textEl = document.getElementById("status-text");
      if (state.ui.cooked) {
        pill.querySelector("span").textContent = "üç≥";
        textEl.textContent = "Status: cooked";
      } else if (state.ui.mood === "tired") {
        pill.querySelector("span").textContent = "üòë";
        textEl.textContent = "Status: tired but here";
      } else if (state.ui.mood === "ok") {
        pill.querySelector("span").textContent = "üòå";
        textEl.textContent = "Status: present";
      } else {
        pill.querySelector("span").textContent = "üôÇ";
        textEl.textContent = "Status: here-ish";
      }
    }

    function pickReminder() {
      if (reminderIndex >= REMINDERS.length) reminderIndex = 0;
      const text = REMINDERS[reminderIndex++];
      document.getElementById("reminder-text").textContent = text;
    }

    // --------- SETTINGS RENDER ---------

    function applySettingsToUI() {
      // Tone radios
      const toneRadios = document.querySelectorAll('input[name="tone"]');
      toneRadios.forEach((r) => {
        r.checked = r.value === state.settings.tone;
      });

      // Animations
      document.getElementById("toggle-animations").checked =
        state.settings.animations === false ? true : false;
      if (state.settings.animations === false) {
        document.body.classList.add("no-animations");
      } else {
        document.body.classList.remove("no-animations");
      }

      // Shift inputs
      document.getElementById("start-time").value = state.shift.start;
      document.getElementById("end-time").value = state.shift.end;
      document.getElementById("reward-text").value = state.shift.reward || "";
    }

    // --------- EVENTS & INIT ---------

    function initEvents() {
      // Tabs
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;
          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          tabContents.forEach((c) => {
            if (c.id === "tab-" + target) c.classList.add("active");
            else c.classList.remove("active");
          });
        });
      });

      // Recalculate
      document.getElementById("recalc-btn").addEventListener("click", () => {
        const startVal = document.getElementById("start-time").value;
        const endVal = document.getElementById("end-time").value;
        const rewardVal = document.getElementById("reward-text").value.trim();

        state.shift.start = startVal || "09:00";
        state.shift.end = endVal || "17:00";
        state.shift.reward = rewardVal;
        saveState();
        renderNowTab();
      });

      // Sort units
      document.getElementById("sort-short").addEventListener("click", () => {
        state.ui.sortMode = "short";
        document.getElementById("sort-short").classList.add("active");
        document.getElementById("sort-long").classList.remove("active");
        saveState();
        renderNowTab();
      });
      document.getElementById("sort-long").addEventListener("click", () => {
        state.ui.sortMode = "long";
        document.getElementById("sort-long").classList.add("active");
        document.getElementById("sort-short").classList.remove("active");
        saveState();
        renderNowTab();
      });

      // Quotes & tips
      document.getElementById("quote-next-btn").addEventListener("click", () => {
        pickNextQuote();
      });

      document.getElementById("tip-next-btn").addEventListener("click", () => {
        pickNextTip();
      });

      // Mood buttons
      const moodButtons = document.querySelectorAll(".mood-btn");
      moodButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          state.ui.mood = btn.dataset.mood;
          saveState();
          renderMood();
          renderStatusPill();
        });
      });

      // Water
      document.getElementById("water-add-btn").addEventListener("click", () => {
        ensureWaterDate();
        state.water.count += 1;
        state.water.lastSipTs = Date.now();
        saveState();
        renderWater();
      });

      // Cooked mode
      document.getElementById("cook-btn").addEventListener("click", () => {
        state.ui.cooked = true;
        saveState();
        renderStatusPill();
        const modal = document.getElementById("cook-modal");
        modal.style.display = "flex";
      });
      document.getElementById("cook-dismiss").addEventListener("click", () => {
        document.getElementById("cook-modal").style.display = "none";
      });

      // Settings: tone
      document.querySelectorAll('input[name="tone"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          state.settings.tone = radio.value;
          saveState();
          pickNextQuote();
        });
      });

      // Settings: animations
      document.getElementById("toggle-animations").addEventListener("change", (e) => {
        const disabled = e.target.checked;
        state.settings.animations = !disabled;
        saveState();
        if (disabled) {
          document.body.classList.add("no-animations");
        } else {
          document.body.classList.remove("no-animations");
        }
      });
    }

    function init() {
      loadState();

      // Ensure defaults for missing fields
      state = {
        ...DEFAULT_STATE,
        ...state,
        settings: { ...DEFAULT_STATE.settings, ...(state.settings || {}) },
        shift: { ...DEFAULT_STATE.shift, ...(state.shift || {}) },
        water: { ...DEFAULT_STATE.water, ...(state.water || {}) },
        ui: { ...DEFAULT_STATE.ui, ...(state.ui || {}) }
      };

      applySettingsToUI();
      ensureWaterDate();
      initEvents();

      shuffleArray(REMINDERS);
      shuffleArray(TIPS);

      renderNowTab();
      pickNextQuote();
      pickNextTip();
      renderMood();
      renderWater();
      renderStatusPill();
      pickReminder();

      setInterval(() => {
        renderNowTab();
        renderWater(); // to keep "since last sip" line fresh
      }, 1000);
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
